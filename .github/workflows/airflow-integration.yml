name: Airflow Integration

on:
  push:
    paths:
      - 'profilemesh/**'
      - 'examples/**'
      - 'docker/**'
      - 'tests/**'
      - 'requirements.txt'
      - 'setup.py'
      - '.github/workflows/airflow-integration.yml'
  pull_request:
    paths:
      - 'profilemesh/**'
      - 'examples/**'
      - 'docker/**'
      - 'tests/**'
      - 'requirements.txt'
      - 'setup.py'
      - '.github/workflows/airflow-integration.yml'

jobs:
  airflow-integration:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          # Install apache-airflow first to avoid conflicts
          pip install apache-airflow==2.8.1 --constraint "https://raw.githubusercontent.com/apache/airflow/constraints-2.8.1/constraints-3.10.txt"
          pip install -r requirements.txt
          pip install pytest pytest-cov
          # Install profilemesh with airflow extras
          pip install -e ".[airflow]"

      # Note: Skipping import checks because Airflow initializes on import
      # Docker validation below will catch any import/syntax errors

      - name: Start Airflow stack (official setup)
        run: |
          cd docker
          # Start all services (init will run migrations and create admin user)
          docker compose -f docker-compose-airflow.yml up -d

      - name: Wait for Airflow webserver
        run: |
          cd docker
          echo "Waiting for Airflow init to complete..."
          docker compose -f docker-compose-airflow.yml logs -f airflow-init &
          
          for i in {1..60}; do
            if curl -f http://localhost:8080/health 2>/dev/null; then
              ready=1
              break
            fi
            echo "Waiting for Airflow webserver... (attempt $i/60)"
            sleep 10
          done
          if [ -z "$ready" ]; then
            echo "Airflow webserver did not become ready"
            docker compose -f docker-compose-airflow.yml logs airflow-webserver
            docker compose -f docker-compose-airflow.yml logs airflow-scheduler
            exit 1
          fi
          echo "âœ“ Airflow webserver is healthy"

      - name: List Airflow DAGs
        run: |
          cd docker
          docker compose -f docker-compose-airflow.yml exec -T airflow-webserver \
            airflow dags list | tee ../dags_list.txt
          cat ../dags_list.txt

      - name: Validate ProfileMesh DAGs exist
        run: |
          grep -q "profilemesh_profile_all" dags_list.txt
          grep -q "profilemesh_profile_parallel" dags_list.txt
          grep -q "profilemesh_plan_monitor" dags_list.txt

      - name: Test DAG parsing (profile_all)
        run: |
          cd docker
          docker compose -f docker-compose-airflow.yml exec -T airflow-webserver \
            python -c "from airflow.models import DagBag; dag_bag = DagBag(dag_folder='/opt/airflow/dags'); assert 'profilemesh_profile_all' in dag_bag.dags, 'DAG not found'; assert dag_bag.import_errors == {}, f'Import errors: {dag_bag.import_errors}'"

      - name: Test DAG parsing (profile_parallel)
        run: |
          cd docker
          docker compose -f docker-compose-airflow.yml exec -T airflow-webserver \
            python -c "from airflow.models import DagBag; dag_bag = DagBag(dag_folder='/opt/airflow/dags'); assert 'profilemesh_profile_parallel' in dag_bag.dags, 'DAG not found'"

      - name: Test DAG parsing (plan_monitor)
        run: |
          cd docker
          docker compose -f docker-compose-airflow.yml exec -T airflow-webserver \
            python -c "from airflow.models import DagBag; dag_bag = DagBag(dag_folder='/opt/airflow/dags'); assert 'profilemesh_plan_monitor' in dag_bag.dags, 'DAG not found'"

      - name: Verify ProfileMesh operators are importable
        run: |
          cd docker
          docker compose -f docker-compose-airflow.yml exec -T airflow-webserver \
            python -c "from profilemesh.integrations.airflow import ProfileMeshProfilingOperator, ProfileMeshPlanSensor, ProfileMeshTableOperator; print('All operators imported successfully')"

      - name: Check Airflow logs for errors
        if: always()
        run: |
          cd docker
          echo "=== Airflow Init Logs ==="
          docker compose -f docker-compose-airflow.yml logs airflow-init | tail -100
          echo ""
          echo "=== Airflow Webserver Logs ==="
          docker compose -f docker-compose-airflow.yml logs airflow-webserver | tail -100
          echo ""
          echo "=== Airflow Scheduler Logs ==="
          docker compose -f docker-compose-airflow.yml logs airflow-scheduler | tail -100

      - name: Tear down Docker resources
        if: always()
        run: |
          cd docker
          docker compose -f docker-compose-airflow.yml down -v
